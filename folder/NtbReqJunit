@Test
void videoUplaodDcmnt_docSuccess_shouldCallSavedDocument() throws Exception {

    String cif = "CIF123";
    String cstmrNo = "REF123";
    String fileName = "aadhaar.pdf";

    File file = mock(File.class);
    when(file.length()).thenReturn(2048L);

    EDMSResponse docUploadRes = new EDMSResponse();
    docUploadRes.setResponseMsg("DOCUMENTS UPLOADED SUCCESSFULLY");

    EDMSResponse vidUploadRes = new EDMSResponse();
    vidUploadRes.setResponseMsg("NEW DOCUMENT UPLOADED");

    EdmsDoc edmsDoc = new EdmsDoc();

    NtbRequest spy = spy(ntbRequest);

    Method method = NtbRequest.class.getDeclaredMethod(
            "videoUplaodDcmnt",
            String.class,
            String.class,
            EDMSResponse.class,
            EDMSResponse.class,
            EdmsDoc.class,
            File.class,
            String.class
    );
    method.setAccessible(true);

    method.invoke(
            spy,
            cif,
            cstmrNo,
            docUploadRes,
            vidUploadRes,
            edmsDoc,
            file,
            fileName
    );

    verify(spy).savedDocument(
            anyString(),
            eq(cif),
            eq(cstmrNo),
            eq(vidUploadRes),
            eq(edmsDoc),
            eq(file),
            eq(fileName)
    );
}

@Test
void videoUplaodDcmnt_docFailure_nonVkyc_shouldSaveFailure() throws Exception {

    String cif = "CIF123";
    String cstmrNo = "REF123";
    String fileName = "pan.pdf";

    File file = mock(File.class);
    when(file.length()).thenReturn(1024L);

    EDMSResponse docUploadRes = new EDMSResponse();
    docUploadRes.setResponseMsg("FAILED");

    EDMSResponse vidUploadRes = new EDMSResponse();
    vidUploadRes.setResponseMsg("FAILED");

    EdmsDoc edmsDoc = new EdmsDoc();

    Method method = NtbRequest.class.getDeclaredMethod(
            "videoUplaodDcmnt",
            String.class,
            String.class,
            EDMSResponse.class,
            EDMSResponse.class,
            EdmsDoc.class,
            File.class,
            String.class
    );
    method.setAccessible(true);

    method.invoke(
            ntbRequest,
            cif,
            cstmrNo,
            docUploadRes,
            vidUploadRes,
            edmsDoc,
            file,
            fileName
    );

    verify(edmsRepo).save(any(EdmsDoc.class));
}

@Test
void videoUplaodDcmnt_docFailure_vkycWebm_videoSuccess() throws Exception {

    String cif = "CIF123";
    String cstmrNo = "REF123";
    String fileName = "U_VKYC.webm";

    File file = mock(File.class);
    when(file.length()).thenReturn(4096L);

    EDMSResponse docUploadRes = new EDMSResponse();
    docUploadRes.setResponseMsg("FAILED");

    EDMSResponse vidUploadRes = new EDMSResponse();
    vidUploadRes.setResponseMsg("NEW DOCUMENT UPLOADED");

    EdmsDoc edmsDoc = new EdmsDoc();

    Method method = NtbRequest.class.getDeclaredMethod(
            "videoUplaodDcmnt",
            String.class,
            String.class,
            EDMSResponse.class,
            EDMSResponse.class,
            EdmsDoc.class,
            File.class,
            String.class
    );
    method.setAccessible(true);

    method.invoke(
            ntbRequest,
            cif,
            cstmrNo,
            docUploadRes,
            vidUploadRes,
            edmsDoc,
            file,
            fileName
    );

    verify(edmsRepo).save(any(EdmsDoc.class));
}

@Test
void videoUplaodDcmnt_docFailure_vkycWebm_videoFailure() throws Exception {

    String cif = "CIF123";
    String cstmrNo = "REF123";
    String fileName = "U_VKYC.webm";

    File file = mock(File.class);
    when(file.length()).thenReturn(2048L);

    EDMSResponse docUploadRes = new EDMSResponse();
    docUploadRes.setResponseMsg("FAILED");

    EDMSResponse vidUploadRes = new EDMSResponse();
    vidUploadRes.setResponseMsg("FAILED");

    EdmsDoc edmsDoc = new EdmsDoc();

    Method method = NtbRequest.class.getDeclaredMethod(
            "videoUplaodDcmnt",
            String.class,
            String.class,
            EDMSResponse.class,
            EDMSResponse.class,
            EdmsDoc.class,
            File.class,
            String.class
    );
    method.setAccessible(true);

    method.invoke(
            ntbRequest,
            cif,
            cstmrNo,
            docUploadRes,
            vidUploadRes,
            edmsDoc,
            file,
            fileName
    );

    verify(edmsRepo).save(any(EdmsDoc.class));
}










@Test
void savedDocument_nonVkycFile_success() throws Exception {

    String cif = "CIF123";
    String cstmrNo = "REF123";
    String fileName = "aadhaar.pdf";

    File file = mock(File.class);
    when(file.length()).thenReturn(2048L);

    EDMSResponse vidUploadRes = new EDMSResponse();
    vidUploadRes.setResponseMsg("NEW DOCUMENT UPLOADED");

    EdmsDoc edmsDoc = new EdmsDoc();

    Method method = NtbRequest.class.getDeclaredMethod(
            "savedDocument",
            String.class,
            String.class,
            String.class,
            EDMSResponse.class,
            EdmsDoc.class,
            File.class,
            String.class
    );
    method.setAccessible(true);

    method.invoke(
            ntbRequest,
            "TEST_METHOD",
            cif,
            cstmrNo,
            vidUploadRes,
            edmsDoc,
            file,
            fileName
    );

    verify(edmsRepo).save(any(EdmsDoc.class));
}

@Test
void savedDocument_vkycWebm_videoSuccess() throws Exception {

    String cif = "CIF123";
    String cstmrNo = "REF123";
    String fileName = "U_VKYC.webm";

    File file = mock(File.class);
    when(file.length()).thenReturn(4096L);

    EDMSResponse vidUploadRes = new EDMSResponse();
    vidUploadRes.setResponseMsg("NEW DOCUMENT UPLOADED");

    EdmsDoc edmsDoc = new EdmsDoc();

    Method method = NtbRequest.class.getDeclaredMethod(
            "savedDocument",
            String.class,
            String.class,
            String.class,
            EDMSResponse.class,
            EdmsDoc.class,
            File.class,
            String.class
    );
    method.setAccessible(true);

    method.invoke(
            ntbRequest,
            "TEST_METHOD",
            cif,
            cstmrNo,
            vidUploadRes,
            edmsDoc,
            file,
            fileName
    );

    verify(edmsRepo).save(any(EdmsDoc.class));
}

@Test
void savedDocument_vkycWebm_videoFailure() throws Exception {

    String cif = "CIF123";
    String cstmrNo = "REF123";
    String fileName = "U_VKYC.webm";

    File file = mock(File.class);
    when(file.length()).thenReturn(1024L);

    EDMSResponse vidUploadRes = new EDMSResponse();
    vidUploadRes.setResponseMsg("FAILED");

    EdmsDoc edmsDoc = new EdmsDoc();

    Method method = NtbRequest.class.getDeclaredMethod(
            "savedDocument",
            String.class,
            String.class,
            String.class,
            EDMSResponse.class,
            EdmsDoc.class,
            File.class,
            String.class
    );
    method.setAccessible(true);

    method.invoke(
            ntbRequest,
            "TEST_METHOD",
            cif,
            cstmrNo,
            vidUploadRes,
            edmsDoc,
            file,
            fileName
    );

    verify(edmsRepo).save(any(EdmsDoc.class));
}









package com.sbi.yono.document.savingsaccount.edms.ntbupload;

import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import java.io.File;
import java.security.PrivateKey;
import java.security.PublicKey;
import java.security.cert.X509Certificate;
import java.util.List;
import java.util.Optional;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.junit.jupiter.MockitoExtension;

import com.sbi.yono.account.savingsaccount.accntopening.ekycpdf.CustomerOnboarding;
import com.sbi.yono.account.savingsaccount.accntopening.ekycpdf.CustomerOnboardingRepository;
import com.sbi.yono.account.savingsaccount.accntopening.ekycpdf.EKYCSvc;
import com.sbi.yono.document.savingsaccount.edms.bean.EDMSResponse;
import com.sbi.yono.document.savingsaccount.edms.bean.ReqBean;
import com.sbi.yono.document.savingsaccount.edms.bean.RequestBean;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.AccOnbrdingRepo;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.CustOnbrdingRepo;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.EdmsRepo;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.OvdRepo;
import com.sbi.yono.document.savingsaccount.edms.entity.CustomerOnbrding;
import com.sbi.yono.document.savingsaccount.edms.entity.OvdDtls;
import com.sbi.yono.document.savingsaccount.edms.upload.Audit;
import com.sbi.yono.document.savingsaccount.edms.upload.CallApi;
import com.sbi.yono.document.savingsaccount.edms.upload.Details;
import com.sbi.yono.document.savingsaccount.edms.utility.SaveEdmsResponse;
import com.tcs.techbone.cryptography.kms.service.KeyManagementService;

@ExtendWith(MockitoExtension.class)
class NtbRequestTest {

    @Mock
    private AccOnbrdingRepo accccOnbrdingRepo;

    @Mock
    private EKYCSvc ekycsvc;

    @Mock
    private EdmsRepo edmsRepo;

    @Mock
    private CustomerOnboardingRepository customerOnboardingRepository;

    @Mock
    private CustOnbrdingRepo custOnbrdingRepo;

    @Mock
    private OvdRepo ovdRepo;

    @Mock
    private Details details;

    @Mock
    private CallApi callApi;

    @Mock
    private SaveEdmsResponse saveResp;

    @Mock
    private Audit audit;

    @InjectMocks
    private NtbRequest ntbRequest;

    @BeforeEach
    void setUp() {
        // Inject path manually (used for file path creation)
        ntbRequest.setPath1("/tmp/");
    }

    /**
     * JUnit for FIRST METHOD: callEdms()
     */
    @Test
    void callEdms_successFlow_shouldUploadDocAndVideo() throws Exception {

        // ---------- Arrange ----------

        CustomerOnbrding customer = new CustomerOnbrding();
        customer.setRef_no("REF123");
        customer.setBranchCode("001");
        customer.setChckrId(0);
        customer.setMkrId(0);

        List<CustomerOnbrding> results = List.of(customer);

        when(accccOnbrdingRepo.findByaccNo("REF123")).thenReturn("123456789");
        when(accccOnbrdingRepo.findByCifNo("REF123")).thenReturn("987654321");

        when(ovdRepo.findOvdDtls("REF123")).thenReturn(Optional.empty());

        RequestBean requestBean = new RequestBean();
        requestBean.setChannelId("APP");

        when(details.sendDoc(
                anyString(),
                anyString(),
                anyString(),
                anyString(),
                anyString(),
                any()
        )).thenReturn(requestBean);

        ReqBean videoReq = new ReqBean();
        videoReq.setChannelId("APP");
        videoReq.setBase64("base64Video");

        // Details2 is created using new(), so spy is required
        NtbRequest spyRequest = Mockito.spy(ntbRequest);
        doReturn(videoReq)
                .when(spyRequest)
                .createVdoc(anyString(), anyString(), anyString());

        EDMSResponse docResponse = new EDMSResponse();
        docResponse.setResponseCode("00");
        docResponse.setResponseMsg("DOCUMENTS UPLOADED SUCCESSFULLY");

        EDMSResponse videoResponse = new EDMSResponse();
        videoResponse.setResponseCode("00");
        videoResponse.setResponseMsg("NEW DOCUMENT UPLOADED");

        when(callApi.callEDMSAPI(
                any(),
                anyString(),
                any(),
                any(),
                anyString()
        )).thenReturn(docResponse, videoResponse);

        CustomerOnboarding onboarding = new CustomerOnboarding();
        onboarding.setCheckerId(0);
        onboarding.setMakerId(0);

        when(customerOnboardingRepository.findByonboardingRefNo("REF123"))
                .thenReturn(Optional.of(onboarding));

        when(customerOnboardingRepository.findById("REF123"))
                .thenReturn(Optional.of(onboarding));

        // Mock KMS static calls
        X509Certificate cert = mock(X509Certificate.class);
        PublicKey publicKey = mock(PublicKey.class);
        PrivateKey privateKey = mock(PrivateKey.class);

        when(cert.getPublicKey()).thenReturn(publicKey);

        mockStatic(KeyManagementService.class);
        when(KeyManagementService.getKeyObject(anyString()))
                .thenReturn(cert)
                .thenReturn(privateKey);

        // ---------- Act ----------
        spyRequest.callEdms(results);

        // ---------- Assert ----------

        verify(custOnbrdingRepo).saveUpdtDate("REF123");

        verify(details).sendDoc(
                anyString(),
                anyString(),
                anyString(),
                anyString(),
                anyString(),
                any()
        );

        verify(callApi, atLeastOnce()).callEDMSAPI(
                any(),
                anyString(),
                any(),
                any(),
                anyString()
        );

        verify(audit).performAudit(
                eq("REF123"),
                any(),
                eq(docResponse),
                anyString(),
                eq("edms_upload_doc_ntb")
        );

        verify(audit).performVideoAudit(
                eq("REF123"),
                any(),
                eq(videoResponse),
                anyString(),
                eq("edms_video_doc_ntb")
        );
    }
}









ttttttttttt

package com.sbi.yono.document.savingsaccount.edms.ntbupload;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.Serializable;
import java.security.PrivateKey;
import java.security.PublicKey;
import java.security.cert.X509Certificate;
import java.time.LocalDateTime;
import java.util.Base64;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import org.apache.commons.lang3.exception.ExceptionUtils;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import com.google.gson.Gson;
import com.sbi.yono.account.savingsaccount.accntopening.ekycpdf.CustomerOnboarding;
import com.sbi.yono.account.savingsaccount.accntopening.ekycpdf.CustomerOnboardingRepository;
import com.sbi.yono.account.savingsaccount.accntopening.ekycpdf.EKYCSvc;
import com.sbi.yono.document.savingsaccount.edms.bean.EDMSResponse;
import com.sbi.yono.document.savingsaccount.edms.bean.ReqBean;
import com.sbi.yono.document.savingsaccount.edms.bean.RequestBean;
import com.sbi.yono.document.savingsaccount.edms.constants.Constants;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.AccOnbrdingRepo;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.CustOnbrdingRepo;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.EdmsRepo;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.OvdRepo;
import com.sbi.yono.document.savingsaccount.edms.entity.CustomerOnbrding;
import com.sbi.yono.document.savingsaccount.edms.entity.EdmsDoc;
import com.sbi.yono.document.savingsaccount.edms.entity.OvdDtls;
import com.sbi.yono.document.savingsaccount.edms.etbupload.EtbUploadConstant;
import com.sbi.yono.document.savingsaccount.edms.upload.Audit;
import com.sbi.yono.document.savingsaccount.edms.upload.CallApi;
import com.sbi.yono.document.savingsaccount.edms.upload.Details;
import com.sbi.yono.document.savingsaccount.edms.upload.Details2;
import com.sbi.yono.document.savingsaccount.edms.upload.EdmsUploadConstants;
import com.sbi.yono.document.savingsaccount.edms.utility.LoggingAspect;
import com.sbi.yono.document.savingsaccount.edms.utility.SaveEdmsResponse;
import com.tcs.techbone.channel.global.reader.GlobalConfigPropertiesReader;
import com.tcs.techbone.cryptography.kms.service.KeyManagementService;
import com.tcs.techbone.exception.ServiceBusinessException;
import com.tcs.techbone.exception.ServiceException;
import com.tcs.techbone.exception.TechboneKMSException;
import com.tcs.techbone.logger.FLogger;
import com.tcs.techbone.service.BaseService;

@Service
public class NtbRequest extends BaseService implements Serializable {

	private static final long serialVersionUID = 1L;
	String thiClass = NtbUploadConstant.NTB_REQUEST;
	private transient AccOnbrdingRepo accccOnbrdingRepo;

	private transient EKYCSvc ekycsvc;
	private transient EdmsRepo edmsRepo;
	private transient CustomerOnboardingRepository customerOnboardingRepository;
	private transient CustOnbrdingRepo custOnbrdingRepo;
	private transient OvdRepo ovdRepo;
	private transient Details details;
	private transient CallApi callApi;
	private final transient SaveEdmsResponse saveResp;
	private transient LoggingAspect loggingAspect = new LoggingAspect();
	private final Audit audit;

	@Value("${path1}")
	private String path1;

	private String edmsServer = (String) GlobalConfigPropertiesReader.getInstance()
			.getPropertyById(NtbUploadConstant.EDMS_SERVER);
	private String vkycDoc = (String) GlobalConfigPropertiesReader.getInstance()
			.getPropertyById(NtbUploadConstant.EDMS_VKYC_DOC);
	private String vkycVideo = (String) GlobalConfigPropertiesReader.getInstance()
			.getPropertyById(NtbUploadConstant.EDMS_VKYC_VIDEO);
	private String ckycDoc = (String) GlobalConfigPropertiesReader.getInstance()
			.getPropertyById(NtbUploadConstant.EDMS_CKYC_DOC);
	private String path2 = edmsServer + vkycDoc;
	private String path3 = edmsServer + vkycVideo;
	private String path4 = edmsServer + ckycDoc;

	public String getPath1() {
		return path1;
	}

	public void setPath1(String path1) {
		this.path1 = path1;
	}

	public String getPath2() {
		return path2;
	}

	public void setPath2(String path2) {
		this.path2 = path2;
	}

	public String getPath3() {
		return path3;
	}

	public void setPath3(String path3) {
		this.path3 = path3;
	}

	public String getPath4() {
		return path4;
	}

	public void setPath4(String path4) {
		this.path4 = path4;
	}

	public NtbRequest(AccOnbrdingRepo accccOnbrdingRepo, EKYCSvc ekycsvc, EdmsRepo edmsRepo,
			CustomerOnboardingRepository customerOnboardingRepository, Details details, CallApi callApi,
			OvdRepo ovdRepo, CustOnbrdingRepo custOnbrdingRepo, SaveEdmsResponse saveResp, Audit audit) {

		this.accccOnbrdingRepo = accccOnbrdingRepo;
		this.ekycsvc = ekycsvc;
		this.edmsRepo = edmsRepo;
		this.customerOnboardingRepository = customerOnboardingRepository;
		this.details = details;
		this.callApi = callApi;
		this.ovdRepo = ovdRepo;
		this.custOnbrdingRepo = custOnbrdingRepo;
		this.saveResp = saveResp;
		this.audit = audit;
	}

	/**
	 * Method Name: callEdms Initiates the process of uploading documents and video
	 * KYC for approved customer onboarding records.
	 * 
	 * @param results
	 */
	public void callEdms(List<CustomerOnbrding> results) {
		String thisMethod = NtbUploadConstant.CALL_EDMS;
		String brCode = null;
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod, Constants.METHOD_STARTED);

		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
				NtbUploadConstant.CUSTOMER_ONBRDING_DTLS_PRESENT);
		Map<String, Object> edmsMap = new HashMap<>();
		for (CustomerOnbrding cstmrOnbrdngInfo : results) {
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					NtbUploadConstant.NTB_RQUEST_FOR_REF_NO + cstmrOnbrdngInfo.getRef_no());
			String refNo=cstmrOnbrdngInfo.getRef_no();
			custOnbrdingRepo.saveUpdtDate(cstmrOnbrdngInfo.getRef_no());
			
			String accNo1 = accccOnbrdingRepo.findByaccNo(cstmrOnbrdngInfo.getRef_no());
			String cifNo = accccOnbrdingRepo.findByCifNo(cstmrOnbrdngInfo.getRef_no());
			String accNo = Constants.APPEND_0 + accNo1;
			if (cstmrOnbrdngInfo.getBranchCode() != null) {
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.BRANCH_CODE_IS_PRESENT);
				brCode = cstmrOnbrdngInfo.getBranchCode();
			} else {
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.BRANCH_CODE_IS_NOT_PRESENT);
				brCode = cstmrOnbrdngInfo.getBrnchCd();
			}
			String cif = (Constants.APPEND_0 + cifNo);
			String cstmrNo = cstmrOnbrdngInfo.getRef_no();

			Details2 details2 = new Details2();
			String path = path1;
			Gson gson = new Gson();
			Optional<OvdDtls> ovdDtls = ovdRepo.findOvdDtls(cstmrNo);

			if (!ovdDtls.isPresent()) {
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.NOT_FROM_OVD);
				try {
					FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							NtbUploadConstant.CREATING_EKYC_AND_VKYC_PDF);
					createEkycVkyc(cstmrOnbrdngInfo, cstmrNo, path);
				} catch (ServiceBusinessException | ServiceException e) {
					FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							NtbUploadConstant.CREATE_EKYC_PDF_NOT_PRESENT);
					FLogger.error(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							NtbUploadConstant.EXCEPTION_CREATE_EKYC_PDF_NOT_PRESENT + ExceptionUtils.getStackTrace(e));
					continue;
				}
			}
			RequestBean map;
			try {
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.BEAN_CREATING);
				map = details.sendDoc(cstmrNo, cif, accNo, brCode, path + cstmrNo + File.separatorChar,
						customerOnboardingRepository);
			} catch (ServiceBusinessException e1) {
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.BEAN_NOT_CREATED);
				FLogger.error(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.EXCEPTION_BEAN_NOT_CREATED + ExceptionUtils.getStackTrace(e1));
				continue;
			}
			Map<Object, Object> maskedRequestMap = loggingAspect.maskInstanceOfMap(map);
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					NtbUploadConstant.DOCUMENT_REQUEST + cstmrNo + gson.toJson(maskedRequestMap));
			ReqBean map2 = details2.sendVDoc(cif, brCode,
					path + cstmrNo + File.separatorChar + cstmrNo + Constants.U_VKYC_WEBM);

			String docUploadURL;
			String videoKycUploadUrl = NtbUploadConstant.EMPTY_STR;

			Optional<CustomerOnboarding> cc1 = customerOnboardingRepository.findByonboardingRefNo(cstmrNo);
			if (cc1.isPresent() && cc1.get().getCheckerId() == 0 && cc1.get().getMakerId() == 0) {
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.URL_IS_OF_APP_WEB);
				docUploadURL = path2;
				videoKycUploadUrl = path3;
			} else {
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.URL_IS_OF_BRANCH);
				docUploadURL = path4;
			}

			PublicKey encodedPublicKey = null;
			try {
				FLogger.info(NtbUploadConstant.TIER_NAME, this.getClass().getName(), thisMethod,
						"encodedPublicKey Present");
				encodedPublicKey = ((X509Certificate) KeyManagementService.getKeyObject(Constants.KEY_EDMSPUBKEY))
						.getPublicKey();
			} catch (TechboneKMSException | ClassCastException e) {
				FLogger.info(NtbUploadConstant.TIER_NAME, this.getClass().getName(), thisMethod,
						"encodedPublicKey not present");
				FLogger.error(NtbUploadConstant.TIER_NAME, this.getClass().getName(), thisMethod,
						"Exception encodedPublicKey not present" + ExceptionUtils.getStackTrace(e));
				continue;
			}
			PrivateKey encodedPrivateKey = null;
			try {
				FLogger.info(NtbUploadConstant.TIER_NAME, this.getClass().getName(), thisMethod,
						"encodedPrivateKey Present");
				encodedPrivateKey = (PrivateKey) KeyManagementService.getKeyObject(Constants.KEY_EDMSPRIVAYE_KEY);
			} catch (TechboneKMSException e) {
				FLogger.info(NtbUploadConstant.TIER_NAME, this.getClass().getName(), thisMethod,
						"encodedPrivateKey not present");
				FLogger.error(NtbUploadConstant.TIER_NAME, this.getClass().getName(), thisMethod,
						"Exception encodedPrivateKey not present" + ExceptionUtils.getStackTrace(e));
				continue;
			}

			String channelId = map.getChannelId();

			EDMSResponse docUploadRes = callApi.callEDMSAPI(map, docUploadURL, encodedPublicKey, encodedPrivateKey,
					channelId);
			audit.performAudit(refNo,map, docUploadRes, docUploadURL,"edms_upload_doc_ntb");
			Map<Object, Object> maskedResponsetMap = loggingAspect.maskInstanceOfMap(docUploadRes);
			FLogger.info(Constants.TIER_NAME, NtbRequest.class.getSimpleName(), thisMethod,
					NtbUploadConstant.DOC_UPLOAD_RES + cstmrNo + gson.toJson(maskedResponsetMap));
			EDMSResponse vidUploadRes = null;
			if (map2.getBase64() != null) {
				Map<Object, Object> maskedRequestMap2 = loggingAspect.maskInstanceOfMap(map2);
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.VIDEO_REQUEST + cstmrNo + gson.toJson(maskedRequestMap2));
				channelId = map2.getChannelId();
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.SENDING_VIDEO_REQUEST);
				vidUploadRes = callApi.callEDMSAPI(map2, videoKycUploadUrl, encodedPublicKey, encodedPrivateKey,
						channelId);
				audit.performVideoAudit(refNo,map2, vidUploadRes, videoKycUploadUrl,"edms_video_doc_ntb");
				Map<Object, Object> maskedResponsetMap2 = loggingAspect.maskInstanceOfMap(vidUploadRes);
				FLogger.info(Constants.TIER_NAME, NtbRequest.class.getSimpleName(), thisMethod,
						NtbUploadConstant.VID_UPLOAD_RES + cstmrNo + gson.toJson(maskedResponsetMap2));
			}
			String sourceFolderPath = path + cstmrNo;
			File sourceFolder = new File(sourceFolderPath);
			File[] files = sourceFolder.listFiles();
			EdmsDoc edmsDoc = new EdmsDoc();

			docSave(cif, cstmrNo, docUploadRes, vidUploadRes, files, edmsDoc, cstmrOnbrdngInfo);
			edmsMap.put(Constants.DOC_UPLOAD, docUploadRes);
			edmsMap.put(Constants.VID_UPLOAD, vidUploadRes);
		}
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod, Constants.METHOD_END);
	}

	/**
	 * Method Name: createEkycVkyc createEkycVkyc genrating Pdf of Ekyc Vkyc
	 * 
	 * @param thisMethod
	 * @param cstmrOnbrdngInfo
	 * @param cstmrNo
	 * @param path
	 * @throws ServiceBusinessException
	 * @throws ServiceException
	 */

	public void createEkycVkyc(CustomerOnbrding cstmrOnbrdngInfo, String cstmrNo, String path)
			throws ServiceBusinessException, ServiceException {
		String thisMethod = NtbUploadConstant.CREATE_EKYC_VKCY;
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod, Constants.METHOD_STARTED);
		boolean alreadyPresent = false;
		String filePath = path + cstmrNo + File.separator + cstmrNo + Constants.LEAD_ID + Constants.KYC_1
				+ Constants.LEAD_ID + Constants.EKYC_36 + Constants.EKYC_36_PDF;
		File fileCheck = new File(filePath);
		alreadyPresent = fileCheck.exists();
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
				NtbUploadConstant.EKYC_PDF_ALREADY_PRESENT + alreadyPresent);
		if (!alreadyPresent) {
			String ekycPdf = ekycsvc.pdfCreationEkyc(cstmrNo);
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					NtbUploadConstant.CREATED_EKYC_PDF);
			if (!(ekycPdf.equals(Constants.APPLICANT_DATA_NOT_FOUND))
					&& !(ekycPdf.equals(Constants.AADHAR_DATA_NOT_FOUND))) {
				byte[] decodedBytes = Base64.getDecoder().decode(ekycPdf);
				File file = new File(filePath);
				FLogger.info(Constants.TIER_NAME, thiClass, thisMethod, Constants.GETTINGFILE);
				try (FileOutputStream fileOutputStream = new FileOutputStream(file)) {
					FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							NtbUploadConstant.FILE_OUTPUT_STREAM_PRESENT);
					fileOutputStream.write(decodedBytes);
				} catch (IOException e) {
					FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							NtbUploadConstant.FILE_OUTPUT_STREAM_NOT_PRESENT);
					FLogger.error(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							NtbUploadConstant.EXCEPTION_FILE_OUTPUT_STREAM_NOT_PRESENT
									+ ExceptionUtils.getStackTrace(e));
					throw new ServiceBusinessException(NtbUploadConstant.PATH_NOT_FOUND);
				}
			} else {
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.UNABLE_TO_CREATE_EKYC_DUE_TO_DATA_NOT_FOUND);
			}
		}
		if (cstmrOnbrdngInfo.getChckrId() == 0 && cstmrOnbrdngInfo.getMkrId() == 0) {
			boolean vkycAlreadyPresent = false;
			String filePathvkyc = path + cstmrNo + File.separator + cstmrNo + Constants.LEAD_ID + Constants.CIS
					+ Constants.EKYC_36_PDF;
			File vkycFileCheck = new File(filePathvkyc);
			vkycAlreadyPresent = vkycFileCheck.exists();
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					NtbUploadConstant.VKYC_PDF_ALREADY_PRESENT + vkycAlreadyPresent);
			if (!vkycAlreadyPresent) {
				String vkycPdf = ekycsvc.pdfCreationvkyc(cstmrNo);
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.CREATED_VKYC_PDF);
				byte[] decodedBytesvkyc = Base64.getDecoder().decode(vkycPdf);
				File filevkyc = new File(filePathvkyc);
				FLogger.info(Constants.TIER_NAME, thiClass, thisMethod, Constants.GETTINGFILE);
				try (FileOutputStream fileOutputStream = new FileOutputStream(filevkyc)) {
					FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							NtbUploadConstant.FILE_OUTPUT_STREAM_PRESENT2);
					FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod, Constants.METHOD_END);
					fileOutputStream.write(decodedBytesvkyc);
				} catch (IOException e) {
					FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							NtbUploadConstant.FILE_OUTPUT_STREAM_NOT_PRESENT2);
					FLogger.error(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							NtbUploadConstant.EXCEPTION_FILE_OUTPUT_STREAM_NOT_PRESENT2
									+ ExceptionUtils.getStackTrace(e));
					throw new ServiceBusinessException(NtbUploadConstant.PATH_NOT_FOUND);
				}
			}
		}
	}


	/**
	 * Method Name: docSave Document Save
	 * 
	 * @param cif
	 * @param cstmrNo
	 * @param docUploadRes
	 * @param vidUploadRes
	 * @param files
	 * @param edmsDoc
	 * @param cstmrOnbrdng
	 */
	public void docSave(String cif, String cstmrNo, EDMSResponse docUploadRes, EDMSResponse vidUploadRes, File[] files,
			EdmsDoc edmsDoc, CustomerOnbrding cstmrOnbrdng) {
		String thisMethod = NtbUploadConstant.DOC_SAVE;
		String thisMethod1 = NtbUploadConstant.DOC_SAVE;
		Optional<CustomerOnboarding> cstmrOnbrdngInfo = customerOnboardingRepository.findById(cstmrNo);
		if (cstmrOnbrdngInfo.isPresent()) {
			CustomerOnboarding customerOnboarding = cstmrOnbrdngInfo.get();
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod1, Constants.METHOD_STARTED);
			if (files != null) {
				FLogger.info(Constants.TIER_NAME, thiClass, thisMethod1, Constants.GETTINGFILE);
				if (vidUploadRes != null && docUploadRes != null) {
					for (File file1 : files) {
						String fileName = file1.getName();
						videoUplaodDcmnt(cif, cstmrNo, docUploadRes, vidUploadRes, edmsDoc, file1, fileName);
					}
				}
			}
			if (cstmrOnbrdng.getChckrId() == 0 && cstmrOnbrdng.getMkrId() == 0) {
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.BOTH_CHECKER_AND_MAKER_ID_ARE_EQUAL_TO_ZERO);
				docRespSave(cstmrNo, docUploadRes, vidUploadRes, customerOnboarding);
			} else if (docUploadRes != null) {
				if (docUploadRes.getResponseMsg().contains(Constants.DOCUMENTS_UPLOADED_SUCCESSFULLY)) {
					FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							NtbUploadConstant.BOTH_CHECKER_AND_MAKER_ID_ARE_EQUAL_TO_ZERO);
					Optional<CustomerOnboarding> findById = customerOnboardingRepository.findById(cstmrNo);
					if (findById.isPresent()) {
						FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
								NtbUploadConstant.CUSTOMER_ONBOARDING_PRESENT);
						CustomerOnboarding customerOnboardingInform = findById.get();
						customerOnboardingInform.setStatus(NtbUploadConstant.ZERO_FIFTY_FIVE);
						customerOnboardingInform.setResponseStatus(Integer.parseInt(docUploadRes.getResponseCode()));
						customerOnboardingRepository.save(customerOnboardingInform);
					}
				} else {
					FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							EtbUploadConstant.DOCUMENT_RESPONSE_CODE_IS_NOT_00_FAILED_TO_UPLOAD);
					saveResp.saveNTBEdmsResp(docUploadRes.getResponseCode(), customerOnboarding);
				}
			} else {
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						EtbUploadConstant.DOCS_NOT_UPLOADED_TO_EDMS);
				saveResp.saveNTBEdmsResp(EtbUploadConstant.ONE_THOUSAND_TWO, customerOnboarding);
			}
		}
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod1, Constants.METHOD_END);
	}

	/**
	 * Method Name: docRespSave
	 * 
	 * @param cstmrNo
	 * @param docUploadRes
	 * @param vidUploadRes
	 * @param thisMethod
	 * @param customerOnboarding
	 */
	public void docRespSave(String cstmrNo, EDMSResponse docUploadRes, EDMSResponse vidUploadRes,
			CustomerOnboarding customerOnboarding) {
		String thisMethod = NtbUploadConstant.DOC_RESP_SAVE;
		if (vidUploadRes != null && docUploadRes != null) {
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					NtbUploadConstant.DOC_AND_VIDEO_UPLOAD_RES_PRESENT);
			if (docUploadRes.getResponseMsg().contains(Constants.DOCUMENTS_UPLOADED_SUCCESSFULLY)
					&& vidUploadRes.getResponseMsg().contains(Constants.NEW_DOCUMENT_UPLOADED)) {
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.DOC_UPLOAD_RES_DTLS_PRESENT);
				Optional<CustomerOnboarding> cstmrOnbrdngInform = customerOnboardingRepository.findById(cstmrNo);
				if (cstmrOnbrdngInform.isPresent()) {
					FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							NtbUploadConstant.FIND_BY_ID_DTLS_PRESENT);
					CustomerOnboarding customerOnboardingInform = cstmrOnbrdngInform.get();
					customerOnboardingInform.setStatus(NtbUploadConstant.ZERO_FIFTY_FIVE);
					customerOnboardingInform.setResponseStatus(Integer.parseInt(docUploadRes.getResponseCode()));
					customerOnboardingRepository.save(customerOnboardingInform);
				}
			} else if (docUploadRes.getResponseCode().contains(NtbUploadConstant.RESP_ZERO_THREE)
					&& vidUploadRes.getResponseCode().contains(NtbUploadConstant.RESP_EIGHT_HUNDRED)) {
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						NtbUploadConstant.DOC_UPLOAD_RES_DTLS_PRESENT);
				Optional<CustomerOnboarding> cstmrOnbrdngInform = customerOnboardingRepository.findById(cstmrNo);
				if (cstmrOnbrdngInform.isPresent()) {
					FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							NtbUploadConstant.FIND_BY_ID_DTLS_PRESENT);
					CustomerOnboarding customerOnboardingInform = cstmrOnbrdngInform.get();
					customerOnboardingInform.setStatus(NtbUploadConstant.ZERO_FIFTY_FIVE);
					customerOnboardingInform.setResponseStatus(0);
					customerOnboardingRepository.save(customerOnboardingInform);
				}
			} else {
				saveResp.saveNTBEdmsResp(docUploadRes.getResponseCode(), customerOnboarding);
			}
		} else {
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					EdmsUploadConstants.DOCS_NOT_UPLOADED_TO_EDMS);
			if (null != docUploadRes) {
				saveResp.saveNTBEdmsResp(docUploadRes.getResponseCode(), customerOnboarding);
			} else {
				saveResp.saveNTBEdmsResp(EdmsUploadConstants.ONE_ZERO_ZERO_TWO, customerOnboarding);
			}
		}
	}

	/**
	 * Method Name: videoUplaodDcmnt Video Upload to EDMS
	 * 
	 * @param cif
	 * @param cstmrNo
	 * @param docUploadRes
	 * @param vidUploadRes
	 * @param edmsDoc
	 * @param file1
	 * @param fileName
	 */
	private void videoUplaodDcmnt(String cif, String cstmrNo, EDMSResponse docUploadRes, EDMSResponse vidUploadRes,
			EdmsDoc edmsDoc, File file1, String fileName) {
		String thisMethod = NtbUploadConstant.VIDEO_UPLAOD_DCMNT;
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod, Constants.METHOD_STARTED);
		if (docUploadRes != null && docUploadRes.getResponseMsg().contains(Constants.DOCUMENTS_UPLOADED_SUCCESSFULLY)) {
			FLogger.info(Constants.TIER_NAME, thiClass, thisMethod, Constants.DOCUMENTS_UPLOADED_SUCCESSFULLY);
			savedDocument(thisMethod, cif, cstmrNo, vidUploadRes, edmsDoc, file1, fileName);

		} else {
			FLogger.info(Constants.TIER_NAME, thiClass, thisMethod, NtbUploadConstant.VIDEO_UPLOAD_RESPONSE_FAILED);
			if (!fileName.contains(Constants.U_VKYC_WEBM)) {
				FLogger.info(Constants.TIER_NAME, thiClass, thisMethod,
						Constants.U_VKYC_WEBM + Constants.NEW_DOCUMENT_UPLOADED);
				edmsDoc.setCifNo(cif);
				edmsDoc.setFileSize(String.format(Constants.FKB, file1.length() / 1024.0));
				edmsDoc.setStatus(Constants.FAILURE);
				edmsDoc.setDocName(fileName);
				edmsDoc.setDate(LocalDateTime.now());
				edmsRepo.save(edmsDoc);
				FLogger.info(Constants.TIER_NAME, thiClass, thisMethod, NtbUploadConstant.FAILURE_FOR_DOCUMENT);
			} else if (fileName.contains(Constants.U_VKYC_WEBM)
					&& vidUploadRes.getResponseMsg().contains(Constants.NEW_DOCUMENT_UPLOADED)) {
				FLogger.info(Constants.TIER_NAME, thiClass, thisMethod,
						Constants.U_VKYC_WEBM + Constants.NEW_DOCUMENT_UPLOADED);
				vkycWebm(cif, cstmrNo, edmsDoc, file1);
			} else {
				edmsDoc.setCifNo(cif);
				edmsDoc.setFileSize(String.format(Constants.FKB, file1.length() / 1024.0));
				edmsDoc.setStatus(Constants.FAILURE);
				edmsDoc.setDocName(cstmrNo + NtbUploadConstant.UNDERSCORE + Constants.VKYC_WEBM);
				edmsDoc.setDate(LocalDateTime.now());
				edmsRepo.save(edmsDoc);
				FLogger.info(Constants.TIER_NAME, thiClass, thisMethod, NtbUploadConstant.FAILURE_TO_UPLOAD_VIDEO);
			}
		}
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod, Constants.METHOD_END);
	}

	/**
	 * Method Name: vkycWebm Video Request Save
	 * 
	 * @param cif
	 * @param cstmrNo
	 * @param edmsDoc
	 * @param file1
	 */
	private void vkycWebm(String cif, String cstmrNo, EdmsDoc edmsDoc, File file1) {
		String thisMethod1 = NtbUploadConstant.VKYC_WEBM;
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod1, Constants.METHOD_STARTED);
		edmsDoc.setCifNo(cif);
		edmsDoc.setFileSize(String.format(Constants.FKB, file1.length() / 1024.0));
		edmsDoc.setStatus(Constants.SUCCESS);
		edmsDoc.setDocName(cstmrNo + NtbUploadConstant.UNDERSCORE + Constants.VKYC_WEBM);
		edmsDoc.setDate(LocalDateTime.now());
		edmsRepo.save(edmsDoc);
		FLogger.info(Constants.TIER_NAME, thiClass, thisMethod1, NtbUploadConstant.SUCESS_TO_UPLOAD_VIDEO);
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod1, Constants.METHOD_END);
	}

	/**
	 * Method Name: savedDocument
	 * 
	 * @param thisMethod
	 * @param cif
	 * @param cstmrNo
	 * @param vidUploadRes
	 * @param edmsDoc
	 * @param file1
	 * @param fileName
	 */
	private void savedDocument(String thisMethod, String cif, String cstmrNo, EDMSResponse vidUploadRes,
			EdmsDoc edmsDoc, File file1, String fileName) {
		String thisMethod1 = NtbUploadConstant.SAVED_DOCUMENT;
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod1, Constants.METHOD_STARTED);
		if (!fileName.contains(Constants.U_VKYC_WEBM)) {
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod1,
					NtbUploadConstant.OTHER_THAN + Constants.U_VKYC_WEBM);
			edmsDoc.setCifNo(cif);
			edmsDoc.setFileSize(String.format(Constants.FKB, file1.length() / 1024.0));
			edmsDoc.setStatus(NtbUploadConstant.SUCESS);
			edmsDoc.setDocName(fileName);
			edmsDoc.setDate(LocalDateTime.now());
			edmsRepo.save(edmsDoc);
			FLogger.info(Constants.TIER_NAME, thiClass, thisMethod, NtbUploadConstant.SUCESS_FOR_DOCUMENT);
		} else if (fileName.contains(Constants.U_VKYC_WEBM) && vidUploadRes != null
				&& vidUploadRes.getResponseMsg().contains(NtbUploadConstant.NEW_DOCUMENT_UPLOADED)) {
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod1,
					Constants.U_VKYC_WEBM + NtbUploadConstant.NEW_DOCUMENT_UPLOADED2);
			vkycWebm(cif, cstmrNo, edmsDoc, file1);
		} else {
			edmsDoc.setCifNo(cif);
			edmsDoc.setFileSize(String.format(Constants.FKB, file1.length() / 1024.0));
			edmsDoc.setStatus(Constants.FAILURE);
			edmsDoc.setDocName(cstmrNo + NtbUploadConstant.UNDERSCORE + Constants.VKYC_WEBM);
			edmsDoc.setDate(LocalDateTime.now());
			edmsRepo.save(edmsDoc);
			FLogger.info(Constants.TIER_NAME, thiClass, thisMethod1, NtbUploadConstant.FAILURE_TO_UPLOAD_VIDEO);
		}
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod1, Constants.METHOD_END);
	}

}
