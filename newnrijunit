package com.sbi.yono.document.savingsaccount.edms.upload;

import java.io.File;
import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;

import org.apache.commons.lang3.exception.ExceptionUtils;
import org.json.JSONException;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import com.sbi.yono.document.savingsaccount.edms.commonekyc.CommonEkycPdf;
import com.sbi.yono.document.savingsaccount.edms.constants.Constants;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.CustomerPdRepository;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.EdmsDocDetailsRepo;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.EdmsUploadDocRepo;
import com.sbi.yono.document.savingsaccount.edms.entity.CustomerPd;
import com.sbi.yono.document.savingsaccount.edms.entity.EdmsUploadDoc;
import com.sbi.yono.document.savingsaccount.edms.uploaddoc.GlobalException;
import com.sbi.yono.document.savingsaccount.edms.uploaddoc.UploadDocumentSvc;
import com.sbi.yono.document.savingsaccount.edms.utility.CmnParamsConst;
import com.sbi.yono.document.savingsaccount.edms.utility.CombineImagesToPDF;
import com.sbi.yono.document.savingsaccount.edms.utility.InputValidator;
import com.tcs.techbone.exception.ServiceBusinessException;
import com.tcs.techbone.exception.ServiceException;
import com.tcs.techbone.logger.FLogger;

@Service
public class TriggerNRI {


	String thisClass = EdmsUploadConstants.TRIGGER_NRI;
	private CustomerPdRepository customerPdRepository;
	private EdmsUploadDocRepo edmsUploadDocRepo;
	private EdmsDocDetailsRepo edmsDocDetailsRepo;

	private CommonEkycPdf commonEkycPdf;
	private UploadDocumentSvc uploadDocumentSvc;
	@Value("${path12}")
	private String name;
	@Value("${statusflag}")
	public String statusflag;

	public TriggerNRI(CustomerPdRepository customerPdRepository, EdmsUploadDocRepo edmsUploadDocRepo,
			UploadDocumentSvc uploadDocumentSvc, CommonEkycPdf commonEkycPdf, EdmsDocDetailsRepo edmsDocDetailsRepo) {
		this.customerPdRepository = customerPdRepository;
		this.edmsUploadDocRepo = edmsUploadDocRepo;
		this.uploadDocumentSvc = uploadDocumentSvc;
		this.commonEkycPdf = commonEkycPdf;
		this.edmsDocDetailsRepo = edmsDocDetailsRepo;
	}

	/**
	 * Method Name: triggerSvc Triggers the service operation based on the provided
	 * reference number.
	 * 
	 * @param refNo
	 * @param channelId
	 * @return String
	 * @throws ServiceBusinessException
	 */
	
	
	public String triggerSvcNri(String refNo, String channelId) throws ServiceBusinessException {
		String thisMethod = EdmsUploadConstants.TRIGGER_SVC_NRI;
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod, Constants.METHOD_STARTED);
		ServiceBusinessException businessException = new ServiceBusinessException();
		InputValidator inputValidate = new InputValidator();
		if (refNo.length() == EdmsUploadConstants.INT_TWENTY_EIGHT) {
			FLogger.info(Constants.TIER_NAME, thisMethod, thisClass, EdmsUploadConstants.TRIGGERFLOGGER_ONE);
			if (!inputValidate.refValidator(refNo)) {
				FLogger.info(Constants.TIER_NAME, thisMethod, thisClass, EdmsUploadConstants.TRIGGERFLOGGER_TWO);
				businessException.addBizError(GlobalException.INPUTVALIDATION, EdmsUploadConstants.LEADID);
				FLogger.info(Constants.TIER_NAME, thisMethod, thisClass, EdmsUploadConstants.TRIGGERFLOGGER_TWO);
				ExceptionUtils.getStackTrace(businessException);
				FLogger.error(Constants.TIER_NAME, thisMethod, thisClass,
						ExceptionUtils.getStackTrace(businessException));
				throw businessException;
			}
		} else {
			FLogger.info(Constants.TIER_NAME, thisMethod, thisClass, EdmsUploadConstants.TRIGGERFLOGGER_THREE);
			if (!inputValidate.refvalidatorTwentyFive(refNo)) {
				FLogger.info(Constants.TIER_NAME, thisMethod, thisClass, EdmsUploadConstants.TRIGGERFLOGGER_FOUR);
				businessException.addBizError(GlobalException.INPUTVALIDATION, EdmsUploadConstants.LEADID);
				FLogger.info(Constants.TIER_NAME, thisMethod, thisClass, EdmsUploadConstants.TRIGGERFLOGGER_FOUR);
				ExceptionUtils.getStackTrace(businessException);
				FLogger.error(Constants.TIER_NAME, thisMethod, thisClass,
						ExceptionUtils.getStackTrace(businessException));
				throw businessException;
			}
		}
		try {

			FLogger.info(Constants.TIER_NAME, thisMethod, thisClass,
					EdmsUploadConstants.INTO_TRY_BLOCK_OF_NRI_TRIGGER_SAVE_VALUE_IN_UPLOAD_DOC);
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod, Constants.METHOD_END);
			return setValuesInUploadDoc(refNo, businessException, channelId);

		} catch (Exception e) {
			FLogger.info(Constants.TIER_NAME, thisMethod, thisClass, EdmsUploadConstants.TRIGGERFLOGGER_SIX);
			ServiceBusinessException businessExceptionOne = new ServiceBusinessException();
			FLogger.info(Constants.TIER_NAME, thisMethod, thisClass, EdmsUploadConstants.TRIGGERFLOGGER_SEVEN);
			FLogger.error(Constants.TIER_NAME, thisMethod, thisClass,
					ExceptionUtils.getStackTrace(businessExceptionOne));
			throw businessException;
		}
	}

	/**
	 * Method Name: createEkycCombineVkyc Create Ekyc Pdf, combine,VKYC
	 * 
	 * @param thisMethod
	 * @param cc
	 * @param cstmrNo
	 * @throws ServiceBusinessException
	 */
	public void createEkycCombineVkyc(String cstmrNo, String channelId) throws ServiceBusinessException {
		String thisMethod = EdmsUploadConstants.CREATE_EKYC_COMBINE_VKYC;
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod, Constants.METHOD_STARTED);
		String ekycPdfPath = name;
		String ekycPdf = null;

		try {
			if (Arrays.asList(CmnParamsConst.getMap().get(EdmsUploadConstants.Y_TWO_EDNRI_KEY)).contains(channelId)) {
				FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
						EdmsUploadConstants.TRIGGERFLOGGER_THIRTEEN + channelId);
				ekycPdf = commonEkycPdf.createEkycPdf(cstmrNo, ekycPdfPath);
				uploadDocumentIfPresent(cstmrNo, ekycPdf, EdmsUploadConstants.IDTYPE_TEN);
			}

		} catch (ServiceBusinessException | ServiceException e) {
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					EdmsUploadConstants.TRIGGERFLOGGER_FOURTEEN);
			FLogger.error(Constants.TIER_NAME, MainClassSvc.class.getSimpleName(), thisMethod,
					EdmsUploadConstants.TRIGGERFLOGGER_FIFTEEN + ExceptionUtils.getStackTrace(e));
		}
		try {
			if (Arrays.asList(CmnParamsConst.getMap().get(EdmsUploadConstants.Y_TWO_EDNRI_KEY)).contains(channelId)) {
				List<String> passPortFrontAndBackPath = edmsDocDetailsRepo
						.findFilePathsByRefNoAndTwoDocIdsOrderByDocId(cstmrNo, EdmsUploadConstants.DC_ZERO_ELEVEN, EdmsUploadConstants.DC_ZERO_TWELVE);
				if (passPortFrontAndBackPath.size() > EdmsUploadConstants.NUMBERIC_ZERO) {
					CombineImagesToPDF combineImagesToPDF = new CombineImagesToPDF();

					String passPortCombineBaseSixtyFour = combineImagesToPDF
							.combineImagesToPDF(passPortFrontAndBackPath, cstmrNo);
					String status = uploadDocumentSvc.documentUpload(cstmrNo, EdmsUploadConstants.DC_ZERO_TWENTYFOUR,
							EdmsUploadConstants.EKYC, EdmsUploadConstants.PDF_EXTENSION, passPortCombineBaseSixtyFour);
					if (status.equals(EdmsUploadConstants.SUCCESS)) {
						FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
								EdmsUploadConstants.COMBINE_DOC_FOR_PASSPORT_SAVED_TO_NFS);
					}

				} else {
					FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
							EdmsUploadConstants.FOLLOWING_FILE_PATH_IS_FOR_DOC_ID_IS_NOT_PRESENT_IN_DOC_DTLS_TABLE);
				}
			}
		} catch (ServiceBusinessException e) {
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					EdmsUploadConstants.ERROR_IN_CREATION_PASS_PORT_COMBINE);
			FLogger.error(Constants.TIER_NAME, MainClassSvc.class.getSimpleName(), thisMethod,
					EdmsUploadConstants.ERROR_IN_CREATION_PASS_PORT_COMBINE_TWO + ExceptionUtils.getStackTrace(e));
		}

		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod, Constants.METHOD_END);
	}

	/**
	 * Method : uploadDocumentIfPresent uploading Doc if generated
	 * 
	 * @param thisMethod
	 * @param cstmrNo
	 * @param pdf
	 * @param idType
	 * @throws ServiceBusinessException
	 */
	private void uploadDocumentIfPresent(String cstmrNo, String pdf, String idType) throws ServiceBusinessException {
		String thisMethod = EdmsUploadConstants.PRESENTDOCUPLOAD;
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod, Constants.METHOD_STARTED);
		if (null != pdf && !(pdf.equals(EdmsUploadConstants.APPLICANT_DATA_NOT_FOUND))
				&& !(pdf.equals(EdmsUploadConstants.AADHAR_DATA_NOT_FOUND))) {
			String status = uploadDocumentSvc.documentUpload(cstmrNo, idType, EdmsUploadConstants.EKYC,
					EdmsUploadConstants.PDF_EXTENSION, pdf);
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					status + EdmsUploadConstants.TRIGGERFLOGGER_NINETEEN);
		} else {
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					EdmsUploadConstants.TRIGGERFLOGGER_TWENTY);
		}
	}

	/**
	 * Method Name: setValuesInUploadDoc Sets values in an EdmsUploadDoc object
	 * based on customer and account onboarding data.
	 * 
	 * @param refNo
	 * @param thisMethod
	 * @param businessException
	 * @param channelId
	 * @return String
	 * @throws ServiceBusinessException
	 */

	public String setValuesInUploadDoc(String refNo, ServiceBusinessException businessException, String channelId)
			throws ServiceBusinessException {
		String thisMethod = EdmsUploadConstants.SETVALUEINUPLOADDOC;
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod, Constants.METHOD_STARTED);
		Optional<CustomerPd> customerPdOptional = customerPdRepository.findById(refNo);
		if (customerPdOptional.isEmpty()) {
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					EdmsUploadConstants.TRIGGERFLOGGER_TWENTY_TWO);
			businessException.addBizError(GlobalException.RECORD_NOT_FOUND,
					EdmsUploadConstants.TRIGGERFLOGGER_TWENTY_ONE);
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					EdmsUploadConstants.TRIGGERFLOGGER_TWENTY_TWO);
			FLogger.error(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					EdmsUploadConstants.TRIGGERFLOGGER_TWENTY_THREE + ExceptionUtils.getStackTrace(businessException));
			throw businessException;
		}
		try {
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					EdmsUploadConstants.TRIGGERFLOGGER_TWENTY_FOUR);
			createEkycCombineVkyc(refNo, channelId);
		} catch (ServiceBusinessException | IllegalStateException | JSONException e) {
			FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod,
					EdmsUploadConstants.TRIGGERFLOGGER_TWNETY_FIVE);
			FLogger.error(Constants.TIER_NAME, MainClassSvc.class.getSimpleName(), thisMethod,
					EdmsUploadConstants.TRIGGERFLOGGER_TWENTY_SIX + refNo + ExceptionUtils.getStackTrace(e));
		}
		CustomerPd customerPdData = customerPdOptional.get();
		EdmsUploadDoc uploadDoc = new EdmsUploadDoc();
		uploadDoc.setRefNo(customerPdData.getOnboardingRefNo());
		uploadDoc.setChannelId(channelId);
		uploadDoc.setNoOfPoa(EdmsUploadConstants.INT_ZERO);
		uploadDoc.setNoOfPoi(EdmsUploadConstants.INT_ZERO);
		uploadDoc.setNoOfKyc(EdmsUploadConstants.NUMBERIC_TWO);
		uploadDoc.setNoOfOthers(EdmsUploadConstants.NUMBERIC_TWO);
		uploadDoc.setUploadStatus(false);
		uploadDoc.setUpdtdDate(LocalDateTime.now());
		uploadDoc.setDocUploadPath(EdmsUploadConstants.OPT + File.separator + EdmsUploadConstants.DOCUMENTS
				+ File.separator + refNo + File.separator);

		edmsUploadDocRepo.save(uploadDoc);
		FLogger.info(Constants.TIER_NAME, this.getClass().getName(), thisMethod, Constants.METHOD_END);
		return EdmsUploadConstants.SUCCESS;
	}

}

####$$
package com.sbi.yono.document.savingsaccount.edms.upload;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

import java.util.Collections;
import java.util.Optional;

import org.json.JSONException;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.test.util.ReflectionTestUtils;

import com.sbi.yono.document.savingsaccount.edms.commonekyc.CommonEkycPdf;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.CustomerPdRepository;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.EdmsDocDetailsRepo;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.EdmsUploadDocRepo;
import com.sbi.yono.document.savingsaccount.edms.entity.CustomerPd;
import com.sbi.yono.document.savingsaccount.edms.entity.EdmsUploadDoc;
import com.sbi.yono.document.savingsaccount.edms.uploaddoc.UploadDocumentSvc;
import com.tcs.techbone.exception.ServiceBusinessException;
import com.tcs.techbone.exception.ServiceException;

@ExtendWith(MockitoExtension.class)
class TriggerNRITest {

    @InjectMocks
    private TriggerNRI triggerNRI;

    @Mock
    private CustomerPdRepository customerPdRepository;

    @Mock
    private EdmsUploadDocRepo edmsUploadDocRepo;

    @Mock
    private EdmsDocDetailsRepo edmsDocDetailsRepo;

    @Mock
    private UploadDocumentSvc uploadDocumentSvc;

    @Mock
    private CommonEkycPdf commonEkycPdf;

    @BeforeEach
    void setup() {
        ReflectionTestUtils.setField(triggerNRI, "name", "/tmp");
        ReflectionTestUtils.setField(triggerNRI, "statusflag", "Y");
    }

    /* -------------------------------------------------
     * triggerSvcNri() TEST CASES
     * ------------------------------------------------- */

    @Test
    void triggerSvcNri_validRefNo28_success() throws Exception {
        CustomerPd pd = new CustomerPd();
        pd.setOnboardingRefNo("123");

        when(customerPdRepository.findById(any()))
                .thenReturn(Optional.of(pd));

        String result = triggerNRI.triggerSvcNri(
                "1234567890123456789012345678", "WEB");

        assertEquals("SUCCESS", result);
    }

    @Test
    void triggerSvcNri_invalidRefNo28_throwsException() {
        assertThrows(ServiceBusinessException.class, () ->
                triggerNRI.triggerSvcNri(
                        "INVALIDINVALIDINVALIDINVALID", "WEB"));
    }

    @Test
    void triggerSvcNri_invalidRefNo25_throwsException() {
        assertThrows(ServiceBusinessException.class, () ->
                triggerNRI.triggerSvcNri(
                        "1234567890123456789012345", "WEB"));
    }

    @Test
    void triggerSvcNri_repositoryThrowsException() {
        when(customerPdRepository.findById(any()))
                .thenThrow(RuntimeException.class);

        assertThrows(ServiceBusinessException.class, () ->
                triggerNRI.triggerSvcNri(
                        "1234567890123456789012345678", "WEB"));
    }

    /* -------------------------------------------------
     * setValuesInUploadDoc() TEST CASES
     * ------------------------------------------------- */

    @Test
    void setValuesInUploadDoc_customerNotFound() {
        when(customerPdRepository.findById(any()))
                .thenReturn(Optional.empty());

        assertThrows(ServiceBusinessException.class, () ->
                triggerNRI.setValuesInUploadDoc(
                        "REF123",
                        new ServiceBusinessException(),
                        "WEB"));
    }

    @Test
    void setValuesInUploadDoc_success() throws Exception {
        CustomerPd pd = new CustomerPd();
        pd.setOnboardingRefNo("REF123");

        when(customerPdRepository.findById("REF123"))
                .thenReturn(Optional.of(pd));

        String result = triggerNRI.setValuesInUploadDoc(
                "REF123",
                new ServiceBusinessException(),
                "WEB");

        assertEquals("SUCCESS", result);
    }

    @Test
    void setValuesInUploadDoc_saveCalled() throws Exception {
        CustomerPd pd = new CustomerPd();
        pd.setOnboardingRefNo("REF123");

        when(customerPdRepository.findById(any()))
                .thenReturn(Optional.of(pd));

        triggerNRI.setValuesInUploadDoc(
                "REF123",
                new ServiceBusinessException(),
                "WEB");

        verify(edmsUploadDocRepo, times(1))
                .save(any(EdmsUploadDoc.class));
    }

    @Test
    void setValuesInUploadDoc_createEkycExceptionHandled() throws Exception {
        CustomerPd pd = new CustomerPd();
        pd.setOnboardingRefNo("REF123");

        when(customerPdRepository.findById(any()))
                .thenReturn(Optional.of(pd));

        doThrow(new JSONException("error"))
                .when(commonEkycPdf)
                .createEkycPdf(any(), any());

        assertDoesNotThrow(() ->
                triggerNRI.setValuesInUploadDoc(
                        "REF123",
                        new ServiceBusinessException(),
                        "WEB"));
    }

    /* -------------------------------------------------
     * createEkycCombineVkyc() TEST CASES
     * ------------------------------------------------- */

    @Test
    void createEkycCombineVkyc_validChannel_pdfCreated() throws Exception {
        when(commonEkycPdf.createEkycPdf(any(), any()))
                .thenReturn("PDFDATA");

        triggerNRI.createEkycCombineVkyc("REF123", "Y2");

        verify(commonEkycPdf, atLeastOnce())
                .createEkycPdf(any(), any());
    }

    @Test
    void createEkycCombineVkyc_uploadSuccess() throws Exception {
        when(commonEkycPdf.createEkycPdf(any(), any()))
                .thenReturn("PDFDATA");

        when(uploadDocumentSvc.documentUpload(any(), any(), any(), any(), any()))
                .thenReturn("SUCCESS");

        triggerNRI.createEkycCombineVkyc("REF123", "Y2");

        verify(uploadDocumentSvc, atLeastOnce())
                .documentUpload(any(), any(), any(), any(), any());
    }

    @Test
    void createEkycCombineVkyc_uploadThrowsException() throws Exception {
        when(commonEkycPdf.createEkycPdf(any(), any()))
                .thenReturn("PDFDATA");

        when(uploadDocumentSvc.documentUpload(any(), any(), any(), any(), any()))
                .thenThrow(new ServiceBusinessException());

        assertDoesNotThrow(() ->
                triggerNRI.createEkycCombineVkyc("REF123", "Y2"));
    }

    @Test
    void createEkycCombineVkyc_passportPathsEmpty() throws Exception {
        when(edmsDocDetailsRepo
                .findFilePathsByRefNoAndTwoDocIdsOrderByDocId(any(), any(), any()))
                .thenReturn(Collections.emptyList());

        assertDoesNotThrow(() ->
                triggerNRI.createEkycCombineVkyc("REF123", "Y2"));
    }

    @Test
    void createEkycCombineVkyc_commonPdfThrowsException() throws Exception {
        when(commonEkycPdf.createEkycPdf(any(), any()))
                .thenThrow(new ServiceException("error"));

        assertDoesNotThrow(() ->
                triggerNRI.createEkycCombineVkyc("REF123", "Y2"));
    }

    /* -------------------------------------------------
     * uploadDocumentIfPresent() indirectly covered
     * ------------------------------------------------- */

    @Test
    void uploadDocumentIfPresent_pdfNull() throws Exception {
        when(commonEkycPdf.createEkycPdf(any(), any()))
                .thenReturn(null);

        assertDoesNotThrow(() ->
                triggerNRI.createEkycCombineVkyc("REF123", "Y2"));
    }

    @Test
    void uploadDocumentIfPresent_pdfApplicantNotFound() throws Exception {
        when(commonEkycPdf.createEkycPdf(any(), any()))
                .thenReturn("APPLICANT_DATA_NOT_FOUND");

        assertDoesNotThrow(() ->
                triggerNRI.createEkycCombineVkyc("REF123", "Y2"));
    }

    @Test
    void uploadDocumentIfPresent_pdfAadharNotFound() throws Exception {
        when(commonEkycPdf.createEkycPdf(any(), any()))
                .thenReturn("AADHAR_DATA_NOT_FOUND");

        assertDoesNotThrow(() ->
                triggerNRI.createEkycCombineVkyc("REF123", "Y2"));
    }
}


######
package com.sbi.yono.document.savingsaccount.edms.upload;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

import java.util.Collections;
import java.util.Optional;

import org.json.JSONException;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.mockito.junit.jupiter.MockitoSettings;
import org.mockito.quality.Strictness;
import org.springframework.test.util.ReflectionTestUtils;

import com.sbi.yono.document.savingsaccount.edms.commonekyc.CommonEkycPdf;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.CustomerPdRepository;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.EdmsDocDetailsRepo;
import com.sbi.yono.document.savingsaccount.edms.edms.repo.EdmsUploadDocRepo;
import com.sbi.yono.document.savingsaccount.edms.entity.CustomerPd;
import com.sbi.yono.document.savingsaccount.edms.entity.EdmsUploadDoc;
import com.sbi.yono.document.savingsaccount.edms.uploaddoc.UploadDocumentSvc;
import com.tcs.techbone.exception.ServiceBusinessException;
import com.tcs.techbone.exception.ServiceException;

@ExtendWith(MockitoExtension.class)
@MockitoSettings(strictness = Strictness.STRICT_STUBS)
class TriggerNRITest {

    @InjectMocks
    private TriggerNRI triggerNRI;

    @Mock
    private CustomerPdRepository customerPdRepository;

    @Mock
    private EdmsUploadDocRepo edmsUploadDocRepo;

    @Mock
    private EdmsDocDetailsRepo edmsDocDetailsRepo;

    @Mock
    private UploadDocumentSvc uploadDocumentSvc;

    @Mock
    private CommonEkycPdf commonEkycPdf;

    @BeforeEach
    void setup() {
        ReflectionTestUtils.setField(triggerNRI, "name", "/tmp");
        ReflectionTestUtils.setField(triggerNRI, "statusflag", "Y");
    }

    /* -------------------------------------------------
     * triggerSvcNri()
     * ------------------------------------------------- */

    @Test
    void triggerSvcNri_validRefNo_success() throws Exception {
        CustomerPd pd = new CustomerPd();
        pd.setOnboardingRefNo("REF123");

        when(customerPdRepository.findById(any()))
                .thenReturn(Optional.of(pd));

        String result = triggerNRI.triggerSvcNri(
                "1234567890123456789012345678", "WEB");

        assertEquals("SUCCESS", result);
    }

    @Test
    void triggerSvcNri_invalidRefNo_throwsException() {
        assertThrows(ServiceBusinessException.class, () ->
                triggerNRI.triggerSvcNri("INVALIDINVALIDINVALIDINVALID", "WEB"));
    }

    @Test
    void triggerSvcNri_repositoryException() {
        when(customerPdRepository.findById(any()))
                .thenThrow(RuntimeException.class);

        assertThrows(ServiceBusinessException.class, () ->
                triggerNRI.triggerSvcNri(
                        "1234567890123456789012345678", "WEB"));
    }

    /* -------------------------------------------------
     * setValuesInUploadDoc()
     * ------------------------------------------------- */

    @Test
    void setValuesInUploadDoc_customerNotFound() {
        when(customerPdRepository.findById(any()))
                .thenReturn(Optional.empty());

        assertThrows(ServiceBusinessException.class, () ->
                triggerNRI.setValuesInUploadDoc(
                        "REF123",
                        new ServiceBusinessException(),
                        "WEB"));
    }

    @Test
    void setValuesInUploadDoc_success() throws Exception {
        CustomerPd pd = new CustomerPd();
        pd.setOnboardingRefNo("REF123");

        when(customerPdRepository.findById("REF123"))
                .thenReturn(Optional.of(pd));

        String result = triggerNRI.setValuesInUploadDoc(
                "REF123",
                new ServiceBusinessException(),
                "WEB");

        assertEquals("SUCCESS", result);
        verify(edmsUploadDocRepo).save(any(EdmsUploadDoc.class));
    }

    @Test
    void setValuesInUploadDoc_ekycExceptionHandled() throws Exception {
        CustomerPd pd = new CustomerPd();
        pd.setOnboardingRefNo("REF123");

        when(customerPdRepository.findById(any()))
                .thenReturn(Optional.of(pd));

        // lenient because it may not be invoked depending on channel
        lenient().when(commonEkycPdf.createEkycPdf(any(), any()))
                .thenThrow(new JSONException("error"));

        assertDoesNotThrow(() ->
                triggerNRI.setValuesInUploadDoc(
                        "REF123",
                        new ServiceBusinessException(),
                        "WEB"));
    }

    /* -------------------------------------------------
     * createEkycCombineVkyc()
     * ------------------------------------------------- */

    @Test
    void createEkycCombineVkyc_pdfCreatedAndUploaded() throws Exception {
        when(commonEkycPdf.createEkycPdf(any(), any()))
                .thenReturn("PDFDATA");

        when(uploadDocumentSvc.documentUpload(any(), any(), any(), any(), any()))
                .thenReturn("SUCCESS");

        triggerNRI.createEkycCombineVkyc("REF123", "Y2");

        verify(commonEkycPdf).createEkycPdf(any(), any());
        verify(uploadDocumentSvc, atLeastOnce())
                .documentUpload(any(), any(), any(), any(), any());
    }

    @Test
    void createEkycCombineVkyc_uploadFailureHandled() throws Exception {
        when(commonEkycPdf.createEkycPdf(any(), any()))
                .thenReturn("PDFDATA");

        when(uploadDocumentSvc.documentUpload(any(), any(), any(), any(), any()))
                .thenThrow(new ServiceBusinessException());

        assertDoesNotThrow(() ->
                triggerNRI.createEkycCombineVkyc("REF123", "Y2"));
    }

    @Test
    void createEkycCombineVkyc_passportPathsEmpty() throws Exception {
        lenient().when(edmsDocDetailsRepo
                .findFilePathsByRefNoAndTwoDocIdsOrderByDocId(any(), any(), any()))
                .thenReturn(Collections.emptyList());

        assertDoesNotThrow(() ->
                triggerNRI.createEkycCombineVkyc("REF123", "Y2"));
    }

    @Test
    void createEkycCombineVkyc_commonPdfExceptionHandled() throws Exception {
        when(commonEkycPdf.createEkycPdf(any(), any()))
                .thenThrow(new ServiceException("error"));

        assertDoesNotThrow(() ->
                triggerNRI.createEkycCombineVkyc("REF123", "Y2"));
    }

    /* -------------------------------------------------
     * uploadDocumentIfPresent() via EKYC
     * ------------------------------------------------- */

    @Test
    void uploadDocumentIfPresent_pdfNull() throws Exception {
        when(commonEkycPdf.createEkycPdf(any(), any()))
                .thenReturn(null);

        assertDoesNotThrow(() ->
                triggerNRI.createEkycCombineVkyc("REF123", "Y2"));
    }

    @Test
    void uploadDocumentIfPresent_pdfApplicantNotFound() throws Exception {
        when(commonEkycPdf.createEkycPdf(any(), any()))
                .thenReturn("APPLICANT_DATA_NOT_FOUND");

        assertDoesNotThrow(() ->
                triggerNRI.createEkycCombineVkyc("REF123", "Y2"));
    }
}


