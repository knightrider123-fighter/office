package com.sbi.yono.document.batch.reader;

import java.util.List;

import javax.sql.DataSource;

import org.springframework.batch.item.ItemReader;
import org.springframework.batch.item.ParseException;
import org.springframework.batch.item.UnexpectedInputException;
import org.springframework.dao.DataAccessException;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import com.sbi.yono.document.batch.dto.EtbTriggerDto;
import com.sbi.yono.document.batch.dto.NtbReq;
import com.sbi.yono.document.batch.rowmapper.EtbTriggerRowMapper;
import com.sbi.yono.document.batch.rowmapper.NtbReqRowMapper;
import com.sbi.yono.document.savingsaccount.edms.upload.EdmsUploadConstants;
import com.tcs.techbone.channel.global.reader.GlobalConfigPropertiesReader;
import com.tcs.techbone.exception.ServiceBusinessException;

@Component
public class ListReadingEtbTrigger implements ItemReader<List<EtbTriggerDto>> {

	private final JdbcTemplate jdbcTemplate;
	int pagesize = Integer.parseInt((String) GlobalConfigPropertiesReader.getInstance()
			.getPropertyById(EdmsUploadConstants.EDMS_SEGEMENT_SIZE));
	int interval = 10000;
	private boolean finished = false;

	public ListReadingEtbTrigger(DataSource dataSource) {
		this.jdbcTemplate = new JdbcTemplate();
		this.jdbcTemplate.setDataSource(dataSource);
	}

	@Override
	public List<EtbTriggerDto> read() throws UnexpectedInputException, ParseException, ServiceBusinessException {
		if (finished) {
			return null;
		}

		String sql2 = new StringBuilder().append("SELECT b.ref_no, ").append(" b.channel_id, ").append(" a.cif")
				.append(" FROM yono_dcmnt.edms_upload_doc b ")
				.append(" LEFT JOIN yono_accnt.accnt_onbrdng_status a ON b.ref_no = a.ref_no ")
				.append(" WHERE b.upload_status = false  and b.channel_id in ('Y2EDNCA','Y2EDNSA','Y2EBNCA','Y2EBNSA') ")
				.append("and (b.updtd_dt<= NOW()-INTERVAL '6 SECONDS') ").append("order by b.updtd_dt asc limit ")
				.append(100).toString();

		List<EtbTriggerDto> list;

		try {
			list = jdbcTemplate.query(sql2, new EtbTriggerRowMapper(EtbTriggerDto.class));
		} catch (DataAccessException e) {
			throw new UnexpectedInputException("Failed to read items from the database.", e);
		} catch (Exception e) {
			throw new ServiceBusinessException(e);
		}

		if (list.isEmpty()) {
			finished = true;
			return null;
		}
		return list;

	}
}


package com.sbi.yono.document.batch.processor.etb;

import java.util.List;

import org.json.JSONException;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;

import com.sbi.yono.document.batch.dto.EtbTriggerDto;

class EtbTriggerProcessorTest {

    private EtbTriggerAsyncService asyncService;
    private EtbTriggerProcessor processor;

    @BeforeEach
    void setUp() {
        asyncService = Mockito.mock(EtbTriggerAsyncService.class);
        processor = new EtbTriggerProcessor(asyncService);
    }

    @Test
    void process_shouldCallAsyncService_andReturnSameList() throws JSONException {
        List<EtbTriggerDto> inputList = List.of(new EtbTriggerDto());

        List<EtbTriggerDto> result = processor.process(inputList);

        Assertions.assertNotNull(result);
        Assertions.assertEquals(inputList, result);
        Mockito.verify(asyncService, Mockito.times(1))
               .sendEdmsReq(inputList);
    }

    @Test
    void process_withEmptyList_shouldStillCallAsyncService() throws JSONException {
        List<EtbTriggerDto> inputList = List.of();

        List<EtbTriggerDto> result = processor.process(inputList);

        Assertions.assertNotNull(result);
        Assertions.assertTrue(result.isEmpty());
        Mockito.verify(asyncService, Mockito.times(1))
               .sendEdmsReq(inputList);
    }

    @Test
    void process_withNullList_shouldPassNullToAsyncService() throws JSONException {
        List<EtbTriggerDto> result = processor.process(null);

        Assertions.assertNull(result);
        Mockito.verify(asyncService, Mockito.times(1))
               .sendEdmsReq(null);
    }

    @Test
    void process_shouldNotThrowException() {
        Assertions.assertDoesNotThrow(() -> processor.process(List.of()));
    }

    @Test
    void process_shouldInvokeAsyncExactlyOnce() throws JSONException {
        List<EtbTriggerDto> list = List.of(new EtbTriggerDto());

        processor.process(list);

        Mockito.verify(asyncService, Mockito.only())
               .sendEdmsReq(list);
    }
}




package com.sbi.yono.document.batch.processor.etb;

import java.util.List;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;

import com.sbi.yono.document.batch.dto.EtbTriggerDto;
import com.sbi.yono.document.savingsaccount.edms.etbtrigger.EtbTriggers;

class EtbTriggerAsyncServiceTest {

    private EtbTriggers etbTriggers;
    private EtbTriggerAsyncService asyncService;

    @BeforeEach
    void setUp() {
        etbTriggers = Mockito.mock(EtbTriggers.class);
        asyncService = new EtbTriggerAsyncService(etbTriggers);
    }

    @Test
    void sendEdmsReq_shouldCallEtbTriggerService() {
        List<EtbTriggerDto> list = List.of(new EtbTriggerDto());

        asyncService.sendEdmsReq(list);

        Mockito.verify(etbTriggers, Mockito.times(1))
               .callEtbTrigger(list);
    }

    @Test
    void sendEdmsReq_withEmptyList_shouldStillInvokeService() {
        List<EtbTriggerDto> list = List.of();

        asyncService.sendEdmsReq(list);

        Mockito.verify(etbTriggers, Mockito.times(1))
               .callEtbTrigger(list);
    }

    @Test
    void sendEdmsReq_withNullList_shouldStillInvokeService() {
        asyncService.sendEdmsReq(null);

        Mockito.verify(etbTriggers, Mockito.times(1))
               .callEtbTrigger(null);
    }

    @Test
    void sendEdmsReq_shouldNotThrowException() {
        Assertions.assertDoesNotThrow(() ->
                asyncService.sendEdmsReq(List.of())
        );
    }

    @Test
    void sendEdmsReq_shouldCallServiceOnlyOnce() {
        List<EtbTriggerDto> list = List.of(new EtbTriggerDto());

        asyncService.sendEdmsReq(list);

        Mockito.verify(etbTriggers, Mockito.only())
               .callEtbTrigger(list);
    }
}






package com.sbi.yono.document.batch.processor.etb;

import java.util.List;

import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import com.sbi.yono.document.batch.dto.EtbTriggerDto;
import com.sbi.yono.document.batch.dto.PhotoRetryDto;

import com.sbi.yono.document.savingsaccount.edms.etbtrigger.EtbTriggers;
import com.sbi.yono.document.savingsaccount.edms.phototrigger.PhotoTriggerCall;
import com.tcs.techbone.logger.FLogger;

@Service
public class EtbTriggerAsyncService {
	private static final String METHOD_STARTED = "Method Ended";

	private static final String CLASS_NAME = "ProductMasterProcessor";
	private static final String TIER_NAME = "Document";
	private static final String METHOD_ENDED = "Method Ended";

	
	EtbTriggers etbTriggers;

	public EtbTriggerAsyncService(EtbTriggers etbTriggers) {
		
		this.etbTriggers=etbTriggers;
	}

	@Async
	public void sendEdmsReq(List<EtbTriggerDto> etbTriggerList) {
		String methodName = "sendEdmsReq";
		FLogger.info(TIER_NAME, CLASS_NAME, methodName, METHOD_STARTED);

		etbTriggers.callEtbTrigger(etbTriggerList);
		FLogger.info(TIER_NAME, CLASS_NAME, methodName, METHOD_ENDED);

	}

}





package com.sbi.yono.document.batch.processor.etb;

import java.util.List;
import java.util.Objects;

import org.json.JSONException;
import org.springframework.batch.item.ItemProcessor;

import com.sbi.yono.document.batch.dto.EtbTriggerDto;
import com.sbi.yono.document.batch.dto.PhotoRetryDto;
import com.tcs.techbone.logger.FLogger;

public class EtbTriggerProcessor implements ItemProcessor<List<EtbTriggerDto>, List<EtbTriggerDto>> {
	private static final String METHOD_STARTED = "Method Ended";

	private static final String CLASS_NAME = "ProductMasterProcessor";
	private static final String TIER_NAME = "Document";
	private static final String METHOD_ENDED = "Method Ended";

	private final EtbTriggerAsyncService etbTriggerAsyncService;

	public EtbTriggerProcessor(EtbTriggerAsyncService etbTriggerAsyncService) {
		this.etbTriggerAsyncService = etbTriggerAsyncService;
	}

	@Override
	public List<EtbTriggerDto> process(List<EtbTriggerDto> photoRetryDtoList) throws JSONException {
		String methodName = "process";
		FLogger.info(TIER_NAME, CLASS_NAME, methodName, METHOD_STARTED);
		
				etbTriggerAsyncService.sendEdmsReq(photoRetryDtoList);
		
		
		FLogger.info(TIER_NAME, CLASS_NAME, methodName, METHOD_ENDED);
		return photoRetryDtoList;
	}
}





















package com.sbi.yono.document.batch.processor.rekyc;

import java.util.List;

import org.json.JSONException;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;

import com.sbi.yono.document.batch.dto.RekycTriggerDto;

class RekycTriggerProcessorTest {

    private RekycTriggerAsyncService asyncService;
    private RekycTriggerProcessor processor;

    @BeforeEach
    void setUp() {
        asyncService = Mockito.mock(RekycTriggerAsyncService.class);
        processor = new RekycTriggerProcessor(asyncService);
    }

    @Test
    void process_shouldCallAsyncService_andReturnSameList() throws JSONException {
        List<RekycTriggerDto> inputList = List.of(new RekycTriggerDto());

        List<RekycTriggerDto> result = processor.process(inputList);

        Assertions.assertNotNull(result);
        Assertions.assertEquals(inputList, result);
        Mockito.verify(asyncService, Mockito.times(1))
               .sendEdmsReq(inputList);
    }

    @Test
    void process_withEmptyList_shouldStillCallAsyncService() throws JSONException {
        List<RekycTriggerDto> inputList = List.of();

        List<RekycTriggerDto> result = processor.process(inputList);

        Assertions.assertNotNull(result);
        Assertions.assertTrue(result.isEmpty());
        Mockito.verify(asyncService, Mockito.times(1))
               .sendEdmsReq(inputList);
    }

    @Test
    void process_withNullList_shouldPassNullToAsyncService() throws JSONException {
        List<RekycTriggerDto> result = processor.process(null);

        Assertions.assertNull(result);
        Mockito.verify(asyncService, Mockito.times(1))
               .sendEdmsReq(null);
    }

    @Test
    void process_shouldNotThrowException() {
        Assertions.assertDoesNotThrow(() -> processor.process(List.of()));
    }

    @Test
    void process_shouldInvokeAsyncExactlyOnce() throws JSONException {
        List<RekycTriggerDto> list = List.of(new RekycTriggerDto());

        processor.process(list);

        Mockito.verify(asyncService, Mockito.only())
               .sendEdmsReq(list);
    }
}










package com.sbi.yono.document.batch.processor.rekyc;

import java.util.List;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;

import com.sbi.yono.document.batch.dto.RekycTriggerDto;
import com.sbi.yono.document.savingsaccount.edms.rekyctrigger.RekycTriggerSvc;

class RekycTriggerAsyncServiceTest {

    private RekycTriggerSvc rekycTriggerSvc;
    private RekycTriggerAsyncService asyncService;

    @BeforeEach
    void setUp() {
        rekycTriggerSvc = Mockito.mock(RekycTriggerSvc.class);
        asyncService = new RekycTriggerAsyncService(rekycTriggerSvc);
    }

    @Test
    void sendEdmsReq_shouldCallRekycTriggerService() {
        List<RekycTriggerDto> list = List.of(new RekycTriggerDto());

        asyncService.sendEdmsReq(list);

        Mockito.verify(rekycTriggerSvc, Mockito.times(1))
               .callRekycTrigger(list);
    }

    @Test
    void sendEdmsReq_withEmptyList_shouldStillInvokeService() {
        List<RekycTriggerDto> list = List.of();

        asyncService.sendEdmsReq(list);

        Mockito.verify(rekycTriggerSvc, Mockito.times(1))
               .callRekycTrigger(list);
    }

    @Test
    void sendEdmsReq_withNullList_shouldStillInvokeService() {
        asyncService.sendEdmsReq(null);

        Mockito.verify(rekycTriggerSvc, Mockito.times(1))
               .callRekycTrigger(null);
    }

    @Test
    void sendEdmsReq_shouldNotThrowException() {
        Assertions.assertDoesNotThrow(() ->
                asyncService.sendEdmsReq(List.of())
        );
    }

    @Test
    void sendEdmsReq_shouldCallServiceOnlyOnce() {
        List<RekycTriggerDto> list = List.of(new RekycTriggerDto());

        asyncService.sendEdmsReq(list);

        Mockito.verify(rekycTriggerSvc, Mockito.only())
               .callRekycTrigger(list);
    }
}

















package com.sbi.yono.document.batch.processor.rekyc;

import java.util.List;
import java.util.Objects;

import org.json.JSONException;
import org.springframework.batch.item.ItemProcessor;

import com.sbi.yono.document.batch.dto.EtbTriggerDto;
import com.sbi.yono.document.batch.dto.PhotoRetryDto;
import com.sbi.yono.document.batch.dto.RekycTriggerDto;
import com.tcs.techbone.logger.FLogger;

public class RekycTriggerProcessor implements ItemProcessor<List<RekycTriggerDto>, List<RekycTriggerDto>> {
	private static final String METHOD_STARTED = "Method Ended";

	private static final String CLASS_NAME = "ProductMasterProcessor";
	private static final String TIER_NAME = "Document";
	private static final String METHOD_ENDED = "Method Ended";

	private final RekycTriggerAsyncService etbTriggerAsyncService;

	public RekycTriggerProcessor(RekycTriggerAsyncService etbTriggerAsyncService) {
		this.etbTriggerAsyncService = etbTriggerAsyncService;
	}

	@Override
	public List<RekycTriggerDto> process(List<RekycTriggerDto> photoRetryDtoList) throws JSONException {
		String methodName = "process";
		FLogger.info(TIER_NAME, CLASS_NAME, methodName, METHOD_STARTED);
		
				etbTriggerAsyncService.sendEdmsReq(photoRetryDtoList);
		
		
		FLogger.info(TIER_NAME, CLASS_NAME, methodName, METHOD_ENDED);
		return photoRetryDtoList;
	}
}





package com.sbi.yono.document.batch.processor.rekyc;

import java.util.List;

import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import com.sbi.yono.document.batch.dto.EtbTriggerDto;
import com.sbi.yono.document.batch.dto.PhotoRetryDto;
import com.sbi.yono.document.batch.dto.RekycTriggerDto;
import com.sbi.yono.document.savingsaccount.edms.etbtrigger.EtbTriggers;
import com.sbi.yono.document.savingsaccount.edms.phototrigger.PhotoTriggerCall;
import com.sbi.yono.document.savingsaccount.edms.rekyctrigger.RekycTriggerSvc;
import com.tcs.techbone.logger.FLogger;

@Service
public class RekycTriggerAsyncService {
	private static final String METHOD_STARTED = "Method Ended";

	private static final String CLASS_NAME = "ProductMasterProcessor";
	private static final String TIER_NAME = "Document";
	private static final String METHOD_ENDED = "Method Ended";

	RekycTriggerSvc rekycTriggerSvc;

	public RekycTriggerAsyncService(RekycTriggerSvc rekycTriggerSvc ) {

		this.rekycTriggerSvc = rekycTriggerSvc;
	}

	@Async
	public void sendEdmsReq(List<RekycTriggerDto> rekycTriggerList) {
		String methodName = "sendEdmsReq";
		FLogger.info(TIER_NAME, CLASS_NAME, methodName, METHOD_STARTED);
		rekycTriggerSvc.callRekycTrigger(rekycTriggerList);
		
		FLogger.info(TIER_NAME, CLASS_NAME, methodName, METHOD_ENDED);

	}

}
